<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GenixWipe - Wipe Summary</title>
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <style>
        .summary-container {
            max-width: 1200px; /* Wider for more charts */
            width: 95%;
            padding: 40px;
            text-align: center;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* Three columns */
            gap: 20px;
            margin: 30px 0;
        }
        .chart-item-wrapper {
            background-color: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .chart-item-wrapper h4 {
            color: #003366;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.05rem;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            padding-bottom: 8px;
        }
        .chart-canvas-container {
            height: 180px; /* Standard chart height */
            width: 100%;
        }
        .button-row {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 40px;
        }
        .button-row .btn-primary {
            width: 250px;
            padding: 15px 30px;
        }

        /* Responsive adjustments for the chart grid */
        @media (max-width: 992px) {
            .chart-grid { grid-template-columns: 1fr 1fr; } /* Two columns on tablets */
        }
        @media (max-width: 600px) {
            .chart-grid { grid-template-columns: 1fr; } /* Single column on phones */
            .button-row { flex-direction: column; gap: 15px; }
            .button-row .btn-primary { width: 100%; }
        }
    </style>
</head>
<body class="splash-layout">
    <header class="app-header">
        <h1>Wipe Summary & Verification Report</h1>
    </header>

    <main class="app-main-content">
        <div class="card-panel summary-container">
            
            <h2 style="color: #0056b3; margin-top: 0; margin-bottom: 20px;">Wipe Performance Summary</h2>
            <p style="font-size: 1.1rem; color: #555;">Detailed report of the data sanitization process and verification results.</p>
            
            <div class="chart-grid">
                
                <div class="chart-item-wrapper">
                    <h4>1. Data Erased vs. Residual</h4>
                    <div class="chart-canvas-container"><canvas id="erasureSuccessChart"></canvas></div>
                </div>
                
                <div class="chart-item-wrapper">
                    <h4>2. Final Verification Status</h4>
                    <div class="chart-canvas-container"><canvas id="verificationStatusChart"></canvas></div>
                </div>
                
                <div class="chart-item-wrapper">
                    <h4>3. Sanitization Method Used</h4>
                    <div class="chart-canvas-container"><canvas id="methodUsedChart"></canvas></div>
                </div>
                
                <div class="chart-item-wrapper">
                    <h4>4. Process Time Allocation</h4>
                    <div class="chart-canvas-container"><canvas id="timeDistributionChart"></canvas></div>
                </div>
                
                <div class="chart-item-wrapper">
                    <h4>5. Initial Data Backup Status</h4>
                    <div class="chart-canvas-container"><canvas id="backupStatusChart"></canvas></div>
                </div>
                
                <div class="chart-item-wrapper">
                    <h4>6. Media Destination (Final)</h4>
                    <div class="chart-canvas-container"><canvas id="destinationChart"></canvas></div>
                </div>
                
            </div>

            <div class="button-row">
                <button type="button" class="btn-primary" id="preview-btn" style="background-color: #007bff;">
                    Preview Certificate
                </button>
                <button type="button" class="btn-primary" id="download-btn" style="background-color: #28a745;">
                    Download Certificate
                </button>
            </div>

        </div>
    </main>

    <footer class="app-footer">
        <p>&copy; 2025 GenixWipe. All rights reserved.</p>
    </footer>
    
    <script>
        // Utility function to get form data
        function getFormData() {
            const dataString = localStorage.getItem('certificateDetails');
            return dataString ? JSON.parse(dataString) : {};
        }

        // --- CHART INITIALIZATION LOGIC ---
        function initializeCharts() {
            const data = getFormData();
            const primaryColor = '#0056b3';
            const secondaryColor = '#ffc107';
            const successColor = '#28a745';
            const dangerColor = '#dc3545';
            const infoColor = '#17a2b8';

            const defaultChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { mode: 'index' }
                }
            };
            
            // --- Helper for processing checkbox/radio data ---
            function processCheckboxData(key, fallbackLabels, fallbackData) {
                let values = data[key] || [];
                if (!Array.isArray(values)) values = [values]; 

                if (values.length === 0) return { labels: fallbackLabels, data: fallbackData };

                const labelMap = {
                    'clear': 'Clear', 'purge': 'Purge', 'damage': 'Damage', 'destruct': 'Destruct',
                    'degauss': 'Degauss', 'overwrite': 'Overwrite', 'block-erase': 'Block Erase',
                    'crypto-erase': 'Crypto Erase', 'other': 'Other',
                    'internal-reuse': 'Internal Reuse', 'external-reuse': 'External Reuse',
                    'recycling': 'Recycling', 'manufacturer': 'Manufacturer',
                    'yes': 'Backed Up', 'no': 'No Backup', 'unknown': 'Unknown'
                };

                const counts = {};
                values.forEach(v => {
                    const label = labelMap[v] || v;
                    counts[label] = (counts[label] || 0) + 1;
                });

                return {
                    labels: Object.keys(counts),
                    data: Object.values(counts)
                };
            }

            // 1. Data Erased Success Rate (Doughnut)
            new Chart(document.getElementById('erasureSuccessChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Success', 'Residual'],
                    datasets: [{
                        data: [99.99, 0.01], 
                        backgroundColor: [successColor, dangerColor],
                        hoverOffset: 4
                    }]
                },
                options: defaultChartOptions
            });

            // 2. Final Verification Status (Doughnut)
            new Chart(document.getElementById('verificationStatusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Verified (Full)', 'Unverified'],
                    datasets: [{
                        data: [(data.verification === 'full' ? 100 : 90), (data.verification === 'full' ? 0 : 10)], // Placeholder logic
                        backgroundColor: [infoColor, secondaryColor],
                        hoverOffset: 4
                    }]
                },
                options: defaultChartOptions
            });
            
            // 3. Sanitization Method Used (Bar)
            const methodUsedData = processCheckboxData('method_used', ['Degauss', 'Overwrite', 'Block Erase'], [1, 0, 0]);
            new Chart(document.getElementById('methodUsedChart'), {
                type: 'bar',
                data: {
                    labels: methodUsedData.labels,
                    datasets: [{
                        label: 'Methods Used',
                        data: methodUsedData.data,
                        backgroundColor: primaryColor,
                    }]
                },
                options: {
                    ...defaultChartOptions,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });

            // 4. Time Distribution (Pie)
            new Chart(document.getElementById('timeDistributionChart'), {
                type: 'pie',
                data: {
                    labels: ['Wipe Time', 'Verification', 'Setup'],
                    datasets: [{
                        data: [75, 15, 10], // Placeholder percentages
                        backgroundColor: ['#6f42c1', '#fd7e14', '#17a2b8'], // Purple/Orange/Teal
                        hoverOffset: 4
                    }]
                },
                options: defaultChartOptions
            });
            
            // 5. Initial Data Backup Status (Doughnut)
            const backupData = processCheckboxData('backed_up', ['Unknown'], [1]);
            new Chart(document.getElementById('backupStatusChart'), {
                type: 'doughnut',
                data: {
                    labels: backupData.labels,
                    datasets: [{
                        data: [1, 0, 0], // Simplistic placeholder
                        backgroundColor: [successColor, dangerColor, infoColor],
                    }]
                },
                options: defaultChartOptions
            });
            
            // 6. Post-Sanitization Destination (Polar Area)
            const destinationData = processCheckboxData('destination', ['Recycling'], [1]);
            new Chart(document.getElementById('destinationChart'), {
                type: 'polarArea',
                data: {
                    labels: destinationData.labels,
                    datasets: [{
                        data: [1, 1, 1, 1, 1], // Equal weight for all destinations found
                        backgroundColor: [primaryColor, successColor, dangerColor, infoColor, secondaryColor],
                    }]
                },
                options: defaultChartOptions
            });
        }
        
        // --- BUTTON HANDLERS ---
        document.getElementById('preview-btn').addEventListener('click', () => {
            // Navigate to the Certificate Preview page
            window.location.href = 'certificate-preview.html';
        });

        document.getElementById('download-btn').addEventListener('click', () => {
            // Direct download action
            alert('Simulating direct PDF download and storage. (This will trigger the actual PDF generation/download.)');
            // Add your PDF generation/download logic here (e.g., using jsPDF or a backend call)
        });

        // Run functions on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeCharts();
        });
    </script>
</body>
</html>